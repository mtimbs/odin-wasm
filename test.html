<!DOCTYPE html>
<html lang="en">
<title>WASM TEST</title>
<style>
    * { margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; }
    canvas { display: block; width: 640px; height: 360px; }
    #my-canvas { border: 1px solid #000;}
</style>
<script type="module">


    // var wasm_memory = new WebAssembly.Memory({initial: 256});
    let wasm_memory = null;

    function get_string_from_ptr_len(ptr, len) {
        const mem = new Uint8Array(wasm_memory.buffer)
        console.log({mem})
        const data = mem.slice(ptr).slice(0, len);
        return new TextDecoder().decode(data);
    }


    const imports = {
        env: {
            remove: function(dst_ptr, src_ptr, len) {
                if (dst_ptr == 0 || str_ptr == 0) {
                    return undefined;
                }

                const mem = new Uint8Array(wasm_memory.buffer);
                const dst = mem.slice(dst_ptr).slice(0,len);
                const src = mem.slice(src_ptr).slice(0,len);
                dst.fill(src);
                return dst;
            },
            print_string_ptr_len: function(ptr, len) {
                const s = get_string_from_ptr_len(ptr, len);
                console.log(s);
            },
            fill_canvas: function(x, y, w ,h, col) {
                const canvas = document.getElementById("my-canvas");
                const ctx = canvas.getContext('2d');
                console.log(ctx)
                ctx.beginPath();
                ctx.rect(x, y, w, h)
                ctx.fillStyle = col;
                ctx.fill();

            }

        }
    };

    (async() => {
        const data = await fetch("wasm.wasm");
        const module = await WebAssembly.compile(await data.arrayBuffer());
        window.wasm = await WebAssembly.instantiate(module,imports);
        window.wasm.imports = imports;
        wasm_memory = window.wasm.exports.memory;
        window.wasm.exports._main();
    })()
    // WebAssembly.instantiateStreaming(fetch("wasm.wasm"), imports).then(
    //     (results) => {
    //         results.instance.exports._main();
    //         console.log("export memory", results.instance.exports.memory)
    //         window.wasm = results.instance;
    //         window.wasm.imports = imports;
    //         wasm_memory = window.wasm.exports.memory
    //     },
    // );

</script>
<body>
<canvas id="my-canvas"></canvas>
</body>
</html>